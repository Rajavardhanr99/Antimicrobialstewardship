<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDR Organism Management Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f8f8fa;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-tertiary: #86868b;
            --accent-primary: #0071e3;
            --accent-secondary: #e8f3ff;
            --border-color: #d2d2d7;
            --success-color: #34c759;
            --error-color: #ff3b30;
            --info-color: #0a84ff;
            --stewardship-color: #ff9500;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Animations & Transitions --- */
        .view-transition {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .view-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute; /* Keep it out of flow when hidden */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .fade-in-item {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Component Styles --- */
        .main-container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }

        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .main-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .scenario-card {
            background-color: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            opacity: 0; /* For staggered animation */
        }

        .scenario-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            border-color: var(--accent-primary);
        }

        .scenario-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .scenario-card p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #0077ed;
        }

        .btn-secondary {
            background-color: #e9e9eb;
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: #dcdce0;
        }
        
        .btn-choice {
            width: 100%;
            text-align: left;
            background-color: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .btn-choice:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 15px rgba(0, 113, 227, 0.1);
            transform: translateY(-2px);
        }

        .feedback-card {
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            animation: popIn 0.4s ease-out;
            border-left-width: 5px;
        }
        .feedback-correct { border-color: var(--success-color); background-color: #eaf8ee; }
        .feedback-incorrect { border-color: var(--error-color); background-color: #ffeeed; }
        .feedback-info { border-color: var(--info-color); background-color: var(--accent-secondary); }
        
        .panel {
            background-color: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .panel h3 { font-weight: 600; font-size: 1.25rem; margin-bottom: 1rem; }
        
        .report-table {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            font-size: 0.9rem;
        }
        .report-s { color: var(--success-color); font-weight: 700; }
        .report-r { color: var(--error-color); font-weight: 700; }
        .report-i { color: var(--stewardship-color); font-weight: 700; }
        
        .stewardship-panel {
            border-left: 5px solid var(--stewardship-color);
            background-color: #fff8e6;
        }

        /* --- Flowchart Styles --- */
        .flowchart { display: flex; gap: 2rem; align-items: flex-start; }
        .flowchart-col { display: flex; flex-direction: column; gap: 1.5rem; align-items: center; }
        .flow-box { background-color: #fff; border: 1px solid var(--border-color); padding: 0.75rem 1rem; border-radius: 8px; text-align: center; width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); position: relative; }
        .flow-box.decision { background-color: var(--accent-secondary); border-color: var(--accent-primary); }
        .flow-box.endpoint { background-color: #eaf8ee; border-color: var(--success-color); }
        .flow-box.warning { background-color: #fff8e6; border-color: var(--stewardship-color); }
        .flow-box h4 { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .flow-box p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; }
        .flow-arrow { position: relative; width: 100%; height: 2rem; }
        .flow-arrow::after { content: ''; position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 2px; height: 100%; background-color: var(--border-color); }
        .flow-arrow.down::before { content: ''; position: absolute; left: 50%; bottom: 0; transform: translateX(-50%) rotate(45deg); width: 8px; height: 8px; border-bottom: 2px solid var(--border-color); border-right: 2px solid var(--border-color); }
        
        .summary-section h3 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .summary-section h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-primary); }
        .summary-section p { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .summary-section ul { list-style-position: inside; padding-left: 1rem; margin-bottom: 1rem; color: var(--text-secondary);}
        .summary-section code { background-color: #e9e9eb; padding: 2px 6px; border-radius: 4px; font-family: Menlo, Monaco, Consolas, "Courier New", monospace;}


    </style>
</head>
<body>

    <main id="app" class="main-container">

        <!-- Screen: Scenario Selection -->
        <div id="scenario-selection-screen" class="view-transition">
            <header class="main-header text-center mb-12">
                <h1>Clinical Decision Simulation</h1>
                <p>Advanced Scenarios in Antimicrobial Resistance</p>
            </header>
            <div id="scenario-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Scenarios injected by JS -->
            </div>
             <div class="text-center mt-12">
                <button id="show-summary-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    Learning Summary & Flowchart
                </button>
            </div>
        </div>

        <!-- Screen: Main Simulation -->
        <div id="simulation-screen" class="view-transition view-hidden">
            <header class="mb-10">
                <button id="back-to-menu-btn" class="btn btn-secondary mb-6">‚Üê Main Menu</button>
                <h2 id="scenario-title" class="text-3xl font-bold border-b pb-4"></h2>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column: Patient & Actions -->
                <div class="lg:col-span-3 space-y-8">
                    <div id="patient-presentation" class="panel"></div>
                    <div id="actions-panel" class="panel"></div>
                    <div id="feedback-panel"></div>
                </div>

                <!-- Right Column: Reports & Stewardship -->
                <div class="lg:col-span-2 space-y-8">
                    <div id="reports-panel" class="panel">
                        <h3 class="flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                           Lab Reports
                        </h3>
                        <div id="reports-content" class="text-gray-600">Awaiting specimen collection...</div>
                    </div>
                    <div id="stewardship-panel" class="panel stewardship-panel hidden">
                        <h3 class="text-orange-900 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                            Stewardship Consult
                        </h3>
                        <p id="stewardship-tip" class="text-orange-800"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: Learning Summary -->
        <div id="summary-screen" class="view-transition view-hidden">
             <header class="mb-10">
                <button id="back-to-menu-from-summary-btn" class="btn btn-secondary mb-6">‚Üê Main Menu</button>
                <h2 class="text-3xl font-bold border-b pb-4">Learning Summary & Key Concepts</h2>
            </header>
            <div id="summary-content" class="panel summary-section">
                <!-- Summary content injected by JS -->
            </div>
        </div>
    </main>

    <script type="module">
        // --- DATA: SCENARIOS (Expanded) ---
        const scenarios = [
            // Original scenarios 1-7
            { id: 1, title: "ESBL Cystitis", description: "A common community-acquired infection complicated by an important resistance mechanism.", patient: { name: "Mrs. Gable", age: 68, sex: "Female", history: "Hypertension, Type 2 Diabetes, recurrent UTIs.", presentation: "Presents to the clinic with a 3-day history of dysuria, urinary frequency, and suprapubic pain. She is afebrile and hemodynamically stable.", vitals: { temp: "37.1¬∞C", hr: "88 bpm", bp: "130/75 mmHg", rr: "16/min", spO2: "98% on RA" } }, organism: { name: "Escherichia coli", source: "Urine Culture" }, resistance: { mechanism: "ESBL (CTX-M-15)", phenotype: { "Amikacin": "S", "Ampicillin": "R", "Cefazolin": "R", "Ceftriaxone": "R", "Ciprofloxacin": "R", "Ertapenem": "S", "Meropenem": "S", "Nitrofurantoin": "S", "Piperacillin/Tazobactam": "R", "TMP/SMX": "R" } }, initialActions: [{ text: "Send Urinalysis & Urine Culture, Start Empiric Antibiotics", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "ceftriaxone", text: "Ceftriaxone" }, { id: "ciprofloxacin", text: "Ciprofloxacin" }, { id: "nitrofurantoin", text: "Nitrofurantoin" }, { id: "ertapenem", text: "Ertapenem" }], definitiveChoices: [{ id: "ceftriaxone", text: "Continue Ceftriaxone" }, { id: "ertapenem", text: "Switch to Ertapenem" }, { id: "piperacillin_tazobactam", text: "Switch to Piperacillin-Tazobactam" }, { id: "nitrofurantoin", text: "Switch to Nitrofurantoin" }], correctPath: { empiric: "nitrofurantoin", definitive: "nitrofurantoin" }, stewardshipTip: "For uncomplicated cystitis, oral agents like nitrofurantoin or fosfomycin are preferred to spare broader-spectrum agents like carbapenems, even if the organism is ESBL-producing and susceptible.", references: [] },
            { id: 2, title: "KPC Klebsiella Sepsis", description: "A critically ill ICU patient with a severe hospital-acquired infection caused by a Carbapenem-Resistant Enterobacteriaceae (CRE).", patient: { name: "Mr. Chen", age: 72, sex: "Male", history: "COPD, recent abdominal surgery 10 days ago.", presentation: "Admitted to the ICU 5 days ago. Now develops fever, hypotension, and increased oxygen requirement. He is on a mechanical ventilator.", vitals: { temp: "39.2¬∞C", hr: "125 bpm", bp: "88/50 mmHg", rr: "22/min (on ventilator)", spO2: "91% on 60% FiO2" } }, organism: { name: "Klebsiella pneumoniae", source: "Blood Culture & Endotracheal Aspirate" }, resistance: { mechanism: "KPC (Klebsiella pneumoniae carbapenemase)", phenotype: { "Amikacin": "I", "Ceftazidime": "R", "Ceftazidime/Avibactam": "S", "Cefepime": "R", "Ciprofloxacin": "R", "Colistin": "S", "Ertapenem": "R", "Meropenem": "R (MIC > 8)", "Meropenem/Vaborbactam": "S", "Tigecycline": "S" } }, initialActions: [{ text: "Draw Blood Cultures & Start Empiric Antibiotics for Hospital-Acquired Sepsis", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "piperacillin_tazobactam", text: "Piperacillin-Tazobactam + Vancomycin" }, { id: "meropenem", text: "Meropenem + Vancomycin" }, { id: "cefepime", text: "Cefepime + Vancomycin" }], definitiveChoices: [{ id: "meropenem_high_dose", text: "Continue Meropenem (use high-dose, extended infusion)" }, { id: "colistin_meropenem", text: "Switch to Colistin + Meropenem" }, { id: "ceftazidime_avibactam", text: "Switch to Ceftazidime-Avibactam" }, { id: "tigecycline", text: "Switch to Tigecycline" }], correctPath: { empiric: "meropenem", definitive: "ceftazidime_avibactam" }, stewardshipTip: "Once a specific carbapenemase is identified, therapy should be targeted. Novel BL/BLIs are now preferred over older, more toxic regimens like colistin-based therapy for KPC producers.", references: [] },
            { id: 3, title: "The NDM-1 Challenge", description: "An extremely resistant organism requiring advanced knowledge of resistance mechanisms and combination therapy.", patient: { name: "Mr. Singh", age: 55, sex: "Male", history: "Patient transferred from a hospital overseas after a complicated surgery.", presentation: "Develops septic shock 3 days after arrival. Requires vasopressors to maintain blood pressure.", vitals: { temp: "38.9¬∞C", hr: "130 bpm", bp: "85/45 mmHg (on norepinephrine)", rr: "28/min", spO2: "92% on NRM" } }, organism: { name: "Enterobacter cloacae", source: "Blood Culture (2/2 sets)" }, resistance: { mechanism: "NDM-1", phenotype: { "Amikacin": "R", "Aztreonam": "S", "Ceftazidime/Avibactam": "R", "Cefiderocol": "S", "Colistin": "S", "Meropenem": "R", "Meropenem/Vaborbactam": "R", "Imipenem/Relebactam": "R", "Tigecycline": "I" } }, initialActions: [{ text: "Draw Blood Cultures & Start Broad-Spectrum Empiric Antibiotics", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "meropenem_colistin", text: "Meropenem + Colistin" }], definitiveChoices: [{ id: "ceftazidime_avibactam_alone", text: "Switch to Ceftazidime-Avibactam" }, { id: "cefiderocol", text: "Switch to Cefiderocol" }, { id: "ceftazidime_avibactam_aztreonam", text: "Switch to Ceftazidime-Avibactam + Aztreonam" }, { id: "colistin_tigecycline", text: "Switch to Colistin + Tigecycline" }], correctPath: { empiric: "meropenem_colistin", definitive: ["cefiderocol", "ceftazidime_avibactam_aztreonam"] }, stewardshipTip: "Metallo-Œ≤-lactamases (MBLs) like NDM-1 hydrolyze nearly all Œ≤-lactams except aztreonam. They are not inhibited by avibactam, vaborbactam, or relebactam. This requires specialized therapy.", references: [] },
            { id: 4, title: "Colonization vs. Infection", description: "A common clinical dilemma: Is the resistant organism causing disease, or is it just 'along for the ride'?", patient: { name: "Mr. Jones", age: 82, sex: "Male", history: "Long-term care facility resident with a chronic indwelling urinary catheter.", presentation: "A routine urine culture, sent as part of an annual check-up, grows a resistant organism. The patient reports no new symptoms.", vitals: { temp: "36.8¬∞C", hr: "76 bpm", bp: "125/80 mmHg", rr: "16/min", spO2: "97% on RA" } }, organism: { name: "Pseudomonas aeruginosa", source: "Urine Culture" }, resistance: { mechanism: "Multiple (Efflux, AmpC)", phenotype: { "Amikacin": "S", "Ceftazidime": "R", "Cefepime": "R", "Ceftolozane/Tazobactam": "S", "Ciprofloxacin": "R", "Colistin": "S", "Meropenem": "R", "Piperacillin/Tazobactam": "R" } }, initialActions: [{ text: "A routine urine culture was sent. Review the results.", action: "showCultureOnly" }], empiricChoices: [], definitiveChoices: [{ id: "no_treatment", text: "Do not treat. This is asymptomatic bacteriuria (colonization)." }, { id: "ceftolozane_tazobactam", text: "Treat with Ceftolozane-Tazobactam" }, { id: "amikacin", text: "Treat with Amikacin" }], correctPath: { empiric: null, definitive: "no_treatment" }, stewardshipTip: "Treating asymptomatic bacteriuria provides no clinical benefit and leads to adverse drug events and promotes further resistance. Do not treat the culture, treat the patient!", references: [] },
            { id: 5, title: "CRAB Septic Shock", description: "A fulminant infection with Carbapenem-Resistant Acinetobacter baumannii (CRAB).", patient: { name: "Ms. Davis", age: 65, sex: "Female", history: "ICU patient for 3 weeks post-cardiac surgery, on a ventilator.", presentation: "Rapidly develops septic shock. Requires high-dose vasopressors.", vitals: { temp: "40.1¬∞C", hr: "140 bpm", bp: "75/40 mmHg (on pressors)", rr: "25/min (vent)", spO2: "89% on 100% FiO2" } }, organism: { name: "Acinetobacter baumannii complex", source: "Blood Culture & BAL" }, resistance: { mechanism: "OXA-23 Carbapenemase, Efflux pumps", phenotype: { "Amikacin": "R", "Cefepime": "R", "Ceftazidime/Avibactam": "R", "Ciprofloxacin": "R", "Colistin": "S", "Meropenem": "R", "Minocycline": "S", "Piperacillin/Tazobactam": "R", "Tigecycline": "I", "TMP/SMX": "R" } }, initialActions: [{ text: "Patient is in shock. Initiate immediate empiric therapy.", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "meropenem_vanc", text: "Meropenem + Vancomycin" }, { id: "meropenem_colistin_vanc", text: "Meropenem + Colistin + Vancomycin" }, { id: "pip_tazo_vanc", text: "Piperacillin-Tazobactam + Vancomycin" }], definitiveChoices: [{ id: "colistin_meropenem", text: "Combination therapy with Colistin + Meropenem" }, { id: "colistin_alone", text: "Monotherapy with Colistin" }, { id: "minocycline", text: "Monotherapy with Minocycline" }], correctPath: { empiric: "meropenem_colistin_vanc", definitive: "colistin_meropenem" }, stewardshipTip: "In patients with septic shock and high risk for CRAB, empiric therapy should be extremely broad. For definitive therapy of severe CRAB infections, combination therapy is often used for potential synergy.", references: [] },
            { id: 6, title: "The Fungal Invader", description: "An ICU patient on multiple antibiotics develops a new fever, raising suspicion for a non-bacterial cause.", patient: { name: "Mr. Rodriguez", age: 78, sex: "Male", history: "Post-op for perforated diverticulitis, has a central line, TPN, and on Meropenem + Vancomycin for 10 days.", presentation: "Develops a new, persistent fever not responding to broad-spectrum antibiotics.", vitals: { temp: "38.8¬∞C", hr: "110 bpm", bp: "115/70 mmHg", rr: "18/min", spO2: "95% on RA" } }, organism: { name: "Candida auris", source: "Blood Culture" }, resistance: { mechanism: "Fungal resistance", phenotype: { "Amphotericin B": "S", "Anidulafungin": "S", "Fluconazole": "R", "Micafungin": "S", "Voriconazole": "R" } }, initialActions: [{ text: "Patient has risk factors for fungal infection. Broaden coverage.", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "fluconazole", text: "Start Fluconazole" }, { id: "anidulafungin", text: "Start Anidulafungin (an echinocandin)" }, { id: "voriconazole", text: "Start Voriconazole" }, { id: "do_nothing", text: "Continue current antibiotics and observe" }], definitiveChoices: [{ id: "continue_anidulafungin", text: "Continue Anidulafungin" }, { id: "switch_fluconazole", text: "Switch to Fluconazole" }, { id: "switch_amphotericin", text: "Switch to Amphotericin B" }], correctPath: { empiric: "anidulafungin", definitive: "continue_anidulafungin" }, stewardshipTip: "In critically ill patients with risk for invasive candidiasis, empiric therapy with an echinocandin is preferred due to rising fluconazole resistance. C. auris is a multidrug-resistant threat requiring strict infection control.", references: [] },
            { id: 7, title: "The AmpC Trap", description: "A lesson in why some susceptibility results can be misleading in vivo.", patient: { name: "Mr. Lee", age: 60, sex: "Male", history: "Hospitalized for pneumonia, treated with ceftriaxone.", presentation: "Initially improved, but on day 4 of therapy, his fever returns and oxygen requirements increase.", vitals: { temp: "38.5¬∞C", hr: "105 bpm", bp: "130/85 mmHg", rr: "22/min", spO2: "93% on 4L NC" } }, organism: { name: "Enterobacter cloacae", source: "Sputum Culture" }, resistance: { mechanism: "Inducible AmpC Œ≤-lactamase", phenotype: { "Cefepime": "S", "Ceftriaxone": "S", "Ciprofloxacin": "S", "Ertapenem": "S", "Gentamicin": "S", "Meropenem": "S", "Piperacillin/Tazobactam": "S" } }, initialActions: [{ text: "Initial cultures sent. Start empiric therapy for HAP.", action: "startEmpiricTherapy" }], empiricChoices: [], definitiveChoices: [{ id: "continue_ceftriaxone", text: "Continue Ceftriaxone; the report says it's susceptible." }, { id: "switch_cefepime", text: "Switch to Cefepime" }, { id: "switch_meropenem", text: "Switch to Meropenem" }], correctPath: { empiric: "cefepime", definitive: "switch_cefepime" }, stewardshipTip: "Enterobacter, Serratia, and Citrobacter (ESC) carry a chromosomal AmpC gene. Exposure to third-generation cephalosporins (e.g., ceftriaxone) can select for mutants that overproduce this enzyme, leading to clinical failure despite an initial 'S' on the report. Cefepime is more stable.", references: [] },
            { id: 8, title: "Antibiogram Challenge", description: "A rapid-fire series of mini-cases to test your ability to interpret complex antibiograms, deduce resistance mechanisms, and select optimal therapy.", isChallenge: true, patient: { name: "Multiple Cases", age: "N/A", sex: "N/A", history: "N/A", presentation: "Select a case file to begin the challenge.", vitals: { temp: "N/A", hr: "N/A", bp: "N/A", rr: "N/A", spO2: "N/A" } }, initialActions: [{ text: "Begin Challenge", action: "startChallenge" }], stewardshipTip: "Each case in this challenge highlights a key principle of antibiogram interpretation. Paying attention to patterns, not just individual 'S' or 'R' results, is crucial for selecting effective and safe therapy.", references: ["CLSI M100 Performance Standards for Antimicrobial Susceptibility Testing."], cases: [ { caseId: '8-11', title: "Basic Case 1: Simple Skin Infection", context: "34M with uncomplicated cellulitis.", organism: { name: "Staphylococcus aureus", source: "Wound" }, resistance: { phenotype: { "Oxacillin": "S", "Penicillin": "R", "Cefazolin": "S", "Clindamycin": "S", "TMP/SMX": "S" } }, interpretation: { question: "What is the correct classification of this organism?", choices: [ {id: "mrsa", text: "MRSA"}, {id: "mssa", text: "MSSA (Methicillin-Susceptible S. aureus)"}, {id: "vre", text: "VRE"} ], correct: "mssa", feedback: "Correct. Oxacillin susceptibility defines this as MSSA. Penicillin resistance is due to a simple penicillinase, which does not affect oxacillin or cephalosporins." }, therapy: { question: "What is the best oral therapy?", choices: [ { id: "vancomycin", text: "Vancomycin" }, { id: "dicloxacillin", text: "Dicloxacillin or Cephalexin" }, { id: "penicillin", text: "Penicillin" } ], correct: "dicloxacillin", feedback: "Correct. For MSSA, a penicillinase-stable penicillin (like dicloxacillin) or a first-generation cephalosporin (like cephalexin) is the drug of choice. Vancomycin is unnecessary." } }, { caseId: '8-12', title: "Basic Case 2: Simple UTI", context: "28F with symptoms of cystitis.", organism: { name: "Escherichia coli", source: "Urine" }, resistance: { phenotype: { "Ampicillin": "R", "Ceftriaxone": "S", "Ciprofloxacin": "R", "Nitrofurantoin": "S", "TMP/SMX": "R" } }, interpretation: { question: "Based on local resistance patterns, what's a common issue seen here?", choices: [ {id: "carbapenem_resistance", text: "Carbapenem resistance"}, {id: "resistance_to_common_agents", text: "High rates of resistance to ampicillin, FQ, and TMP/SMX"}, {id: "esbl", text: "ESBL production"} ], correct: "resistance_to_common_agents", feedback: "Correct. This is a very common pattern for community E. coli, with widespread resistance to older oral agents." }, therapy: { question: "What is a good oral option?", choices: [ { id: "ciprofloxacin", text: "Ciprofloxacin" }, { id: "nitrofurantoin", text: "Nitrofurantoin" }, { id: "ampicillin", text: "Ampicillin" } ], correct: "nitrofurantoin", feedback: "Correct. Nitrofurantoin is an excellent choice for uncomplicated cystitis and this isolate is susceptible. Ciprofloxacin and Ampicillin are resistant." } }, { caseId: '8-13', title: "Basic Case 3: Strep Throat", context: "15M with pharyngitis and fever.", organism: { name: "Streptococcus pyogenes (Group A)", source: "Throat Swab" }, resistance: { phenotype: { "Penicillin": "S", "Erythromycin": "R", "Clindamycin": "S" } }, interpretation: { question: "What is the most important susceptibility fact about S. pyogenes?", choices: [ {id: "vanc_resistance", text: "It is often resistant to vancomycin"}, {id: "universal_pen_s", text: "It is universally susceptible to penicillin"}, {id: "clinda_resistance", text: "It is always resistant to clindamycin"} ], correct: "universal_pen_s", feedback: "Correct. To date, penicillin resistance has never been documented in S. pyogenes. It remains the drug of choice. Macrolide resistance, however, is common." }, therapy: { question: "What is the drug of choice?", choices: [ { id: "erythromycin", text: "Erythromycin" }, { id: "penicillin_or_amoxicillin", text: "Penicillin or Amoxicillin" }, { id: "vancomycin", text: "Vancomycin" } ], correct: "penicillin_or_amoxicillin", feedback: "Correct. Penicillin (or amoxicillin for dosing convenience) is the definitive drug of choice for Group A Strep pharyngitis." } }, { caseId: '8-1', title: "Case 1: Pseudomonas in HAP", context: "67F with HAP.", organism: { name: "Pseudomonas aeruginosa", source: "Sputum" }, resistance: { phenotype: { "Piperacillin/Tazobactam": "R", "Ceftazidime": "R", "Cefepime": "S", "Aztreonam": "R", "Meropenem": "I", "Imipenem": "R", "Ciprofloxacin": "R", "Amikacin": "S", "Ceftolozane/Tazobactam": "S" } }, interpretation: { question: "What is the most likely mechanism?", choices: [ {id: "kpc", text: "KPC carbapenemase"}, {id: "ampc_combo", text: "AmpC hyperproduction + OprD porin loss"}, {id: "esbl", text: "ESBL + efflux pump"} ], correct: "ampc_combo", feedback: "Correct. Resistance to ceftazidime but susceptibility to cefepime is a classic sign of derepressed AmpC in Pseudomonas. Resistance to imipenem with intermediate meropenem points to OprD porin loss." }, therapy: { question: "What is the best therapy?", choices: [ { id: "cefepime", text: "Continue Cefepime" }, { id: "ceftolozane_tazobactam", text: "Switch to Ceftolozane/Tazobactam" }, { id: "amikacin_colistin", text: "Switch to Amikacin + Colistin" } ], correct: "ceftolozane_tazobactam", feedback: "Correct. C/T is optimal as it's designed to overcome these mechanisms. Cefepime alone is risky due to high bacterial load in pneumonia (inoculum effect)." } }, { caseId: '8-2', title: "Case 2: E. faecium in Blood", context: "75M with CLABSI.", organism: { name: "Enterococcus faecium", source: "Blood" }, resistance: { phenotype: { "Ampicillin": "R", "Penicillin": "R", "Vancomycin": "R", "Linezolid": "S", "Daptomycin": "S", "Ciprofloxacin": "R" } }, interpretation: { question: "What is the key phenotype?", choices: [ {id: "mrsa", text: "MRSA"}, {id: "vre", text: "Vancomycin-Resistant Enterococcus (VRE)"}, {id: "cre", text: "CRE"} ], correct: "vre", feedback: "Correct. This is VRE. Ampicillin resistance is also typical for E. faecium." }, therapy: { question: "What is the best therapy?", choices: [ { id: "vancomycin", text: "High-dose Vancomycin" }, { id: "ampicillin_sulbactam", text: "Ampicillin/Sulbactam" }, { id: "linezolid", text: "Linezolid" } ], correct: "linezolid", feedback: "Correct. Linezolid or Daptomycin are first-line for VRE bacteremia." } } ]},
            { id: 9, title: "Dialysis Patient CRBSI", description: "Managing a catheter-related bloodstream infection in an end-stage renal disease patient.", patient: { name: "Mr. Franklin", age: 62, sex: "Male", history: "ESRD on hemodialysis via tunneled catheter, diabetes.", presentation: "Presents to ED with fever and chills during his dialysis session. Looks unwell.", vitals: { temp: "39.5¬∞C", hr: "115 bpm", bp: "100/60 mmHg", rr: "20/min", spO2: "96% on RA" } }, organism: { name: "Staphylococcus aureus", source: "Blood Culture (from catheter and peripheral)" }, resistance: { mechanism: "mecA-positive (MRSA)", phenotype: { "Oxacillin": "R", "Vancomycin": "S (MIC=1)", "Daptomycin": "S (MIC=0.5)", "Linezolid": "S", "Rifampin": "S" } }, initialActions: [{ text: "Draw blood cultures, start empiric antibiotics", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "vancomycin", text: "Vancomycin" }, { id: "cefazolin", text: "Cefazolin" }], definitiveChoices: [{ id: "continue_vancomycin", text: "Continue Vancomycin, retain catheter" }, { id: "switch_daptomycin_remove_catheter", text: "Switch to Daptomycin, remove catheter" }, { id: "continue_vancomycin_remove_catheter", text: "Continue Vancomycin, remove catheter" }], correctPath: { empiric: "vancomycin", definitive: "continue_vancomycin_remove_catheter" }, stewardshipTip: "Source control is paramount in CRBSI. For S. aureus, catheter removal is almost always necessary. Vancomycin remains a first-line agent for MRSA bacteremia.", references: ["IDSA Clinical Practice Guideline for the Diagnosis and Management of Intravascular Catheter-Related Infection."] },
            { id: 10, title: "Neutropenic Fever Puzzle", description: "A high-risk cancer patient develops fever, requiring rapid and broad antimicrobial coverage.", patient: { name: "Ms. Albright", age: 48, sex: "Female", history: "Acute Myeloid Leukemia (AML) post-induction chemotherapy.", presentation: "Day 10 post-chemo, develops fever. Absolute Neutrophil Count (ANC) is 50 cells/¬µL.", vitals: { temp: "38.8¬∞C", hr: "110 bpm", bp: "105/70 mmHg", rr: "18/min", spO2: "98% on RA" } }, organism: { name: "Pseudomonas aeruginosa", source: "Blood Culture" }, resistance: { mechanism: "Multiple (efflux, AmpC)", phenotype: { "Piperacillin/Tazobactam": "R", "Ceftazidime": "R", "Cefepime": "S", "Meropenem": "S", "Ciprofloxacin": "R", "Amikacin": "S" } }, initialActions: [{ text: "Initiate empiric neutropenic fever protocol", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "cefepime", text: "Start Cefepime" }, { id: "ceftriaxone", text: "Start Ceftriaxone" }, { id: "vancomycin", text: "Start Vancomycin" }], definitiveChoices: [{ id: "continue_cefepime", text: "Continue Cefepime" }, { id: "switch_meropenem", text: "Switch to Meropenem" }, { id: "add_amikacin", text: "Add Amikacin to Cefepime" }], correctPath: { empiric: "cefepime", definitive: "continue_cefepime" }, stewardshipTip: "For high-risk neutropenic fever, an anti-pseudomonal beta-lactam like cefepime or piperacillin-tazobactam is the standard of care. Vancomycin is not routinely started unless there's a specific indication (e.g., suspected CRBSI, severe mucositis).", references: ["IDSA Clinical Practice Guideline for the Use of Antimicrobial Agents in Neutropenic Patients with Cancer."] },
            { id: 11, title: "Prosthetic Joint Infection", description: "A subtle but serious infection involving hardware, where biofilm is the main enemy.", patient: { name: "Mr. Harrison", age: 71, sex: "Male", history: "Total hip arthroplasty 2 years ago.", presentation: "6 months of worsening hip pain and a draining sinus tract over the surgical site.", vitals: { temp: "37.5¬∞C", hr: "80 bpm", bp: "135/85 mmHg", rr: "16/min", spO2: "97% on RA" } }, organism: { name: "Staphylococcus epidermidis", source: "Multiple deep tissue cultures" }, resistance: { mechanism: "mecA-positive (methicillin-resistant)", phenotype: { "Oxacillin": "R", "Vancomycin": "S", "Linezolid": "S", "Daptomycin": "S", "Rifampin": "S" } }, initialActions: [{ text: "Patient requires surgery and antibiotics. Awaiting cultures.", action: "showCultureOnly" }], empiricChoices: [], definitiveChoices: [{ id: "vancomycin_monotherapy", text: "Vancomycin monotherapy" }, { id: "vancomycin_rifampin", text: "Vancomycin + Rifampin" }, { id: "linezolid_monotherapy", text: "Linezolid monotherapy" }], correctPath: { empiric: null, definitive: "vancomycin_rifampin" }, stewardshipTip: "Rifampin is uniquely effective at penetrating staphylococcal biofilms. For prosthetic hardware infections, it should always be used in combination with a backbone agent (like vancomycin) to prevent the rapid emergence of rifampin resistance.", references: ["IDSA Clinical Practice Guideline for the Diagnosis and Management of Prosthetic Joint Infection."] },
            { id: 12, title: "Intra-abdominal Abscess", description: "A polymicrobial infection requiring broad coverage, especially for anaerobic bacteria.", patient: { name: "Ms. Wallace", age: 54, sex: "Female", history: "Complicated appendectomy 7 days ago.", presentation: "Develops worsening abdominal pain, fever, and leukocytosis. CT scan shows a 6cm pelvic abscess.", vitals: { temp: "38.9¬∞C", hr: "120 bpm", bp: "110/75 mmHg", rr: "22/min", spO2: "96% on RA" } }, organism: { name: "Polymicrobial: E. coli and Bacteroides fragilis", source: "Abscess fluid" }, resistance: { mechanism: "E. coli is ESBL, B. fragilis is typical", phenotype: { "E. coli": "ESBL+", "Piperacillin/Tazobactam": "S", "Ceftriaxone": "R", "Meropenem": "S", "Ciprofloxacin": "R" } }, initialActions: [{ text: "Drain abscess and start broad empiric antibiotics", action: "startEmpiricTherapy" }], empiricChoices: [{ id: "ceftriaxone_metronidazole", text: "Ceftriaxone + Metronidazole" }, { id: "piperacillin_tazobactam", text: "Piperacillin-Tazobactam" }, { id: "levofloxacin", text: "Levofloxacin" }], definitiveChoices: [{ id: "continue_piperacillin_tazobactam", text: "Continue Piperacillin-Tazobactam" }, { id: "switch_ertapenem", text: "Switch to Ertapenem" }], correctPath: { empiric: "piperacillin_tazobactam", definitive: "switch_ertapenem" }, stewardshipTip: "Piperacillin-tazobactam is excellent empiric therapy for mixed intra-abdominal infections. Once an ESBL is identified, a carbapenem is preferred for definitive therapy of a serious infection. Ertapenem is a good 'stewardship carbapenem' as it spares activity against Pseudomonas.", references: [] },
            { id: 13, title: "The TB Conundrum", description: "Recognizing a classic infectious disease that requires a completely different therapeutic approach.", patient: { name: "Mr. Kim", age: 35, sex: "Male", history: "Recently emigrated from a TB-endemic country.", presentation: "2-month history of productive cough, night sweats, weight loss, and low-grade fevers.", vitals: { temp: "37.9¬∞C", hr: "95 bpm", bp: "115/70 mmHg", rr: "18/min", spO2: "95% on RA" } }, organism: { name: "Mycobacterium tuberculosis complex", source: "Sputum AFB smear/NAAT" }, resistance: { mechanism: "N/A (drug-susceptible)", phenotype: { "Isoniazid": "S", "Rifampin": "S", "Pyrazinamide": "S", "Ethambutol": "S" } }, initialActions: [{ text: "Patient has classic TB symptoms. Place in isolation and get diagnostics.", action: "showCultureOnly" }], empiricChoices: [], definitiveChoices: [{ id: "start_ripe", text: "Start 4-drug therapy (RIPE: Rifampin, Isoniazid, Pyrazinamide, Ethambutol)" }, { id: "start_rifampin", text: "Start Rifampin monotherapy" }, { id: "start_levofloxacin", text: "Start Levofloxacin for community-acquired pneumonia" }], correctPath: { empiric: null, definitive: "start_ripe" }, stewardshipTip: "Treating active tuberculosis with a single agent is a critical error that rapidly selects for drug resistance. Multi-drug combination therapy (RIPE) is the absolute standard of care to ensure cure and prevent transmission of resistant TB.", references: ["CDC Guidelines for the Treatment of Drug-Susceptible Tuberculosis."] }
        ];

        // --- APPLICATION STATE ---
        let currentScenario = null;
        let currentChallengeCase = null;
        
        // --- DOM ELEMENTS ---
        const scenarioSelectionScreen = document.getElementById('scenario-selection-screen');
        const simulationScreen = document.getElementById('simulation-screen');
        const summaryScreen = document.getElementById('summary-screen');
        const scenarioList = document.getElementById('scenario-list');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const backToMenuFromSummaryBtn = document.getElementById('back-to-menu-from-summary-btn');
        const scenarioTitle = document.getElementById('scenario-title');
        const patientPresentation = document.getElementById('patient-presentation');
        const actionsPanel = document.getElementById('actions-panel');
        const feedbackPanel = document.getElementById('feedback-panel');
        const reportsContent = document.getElementById('reports-content');
        const stewardshipPanel = document.getElementById('stewardship-panel');
        const stewardshipTip = document.getElementById('stewardship-tip');
        const showSummaryBtn = document.getElementById('show-summary-btn');
        const summaryContent = document.getElementById('summary-content');

        // --- UI & ANIMATION LOGIC ---
        function switchView(viewToShow) {
            [scenarioSelectionScreen, simulationScreen, summaryScreen].forEach(view => {
                if (view.id === viewToShow) {
                    view.classList.remove('view-hidden');
                } else {
                    view.classList.add('view-hidden');
                }
            });
        }
        
        function animateList(listElement) {
            const items = listElement.children;
            for (let i = 0; i < items.length; i++) {
                items[i].style.opacity = '0';
                items[i].style.animationDelay = `${i * 0.07}s`;
                items[i].classList.add('fade-in-item');
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderScenarioList() {
            scenarioList.innerHTML = scenarios.map(s => `
                <div class="scenario-card" data-id="${s.id}">
                    <h3 class="mb-2">${s.title}</h3>
                    <p>${s.description}</p>
                </div>
            `).join('');
            animateList(scenarioList);
        }
        
        function renderPatientInfo() {
            const { patient } = currentScenario;
            patientPresentation.innerHTML = `
                <h3 class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Patient Profile
                </h3>
                ${ currentScenario.isChallenge ? '' : `
                <p><strong>Patient:</strong> ${patient.name}, ${patient.age}y ${patient.sex}</p>
                <p><strong>History:</strong> ${patient.history}</p> `}
                <p class="mt-2"><strong>Presentation:</strong> ${patient.presentation}</p>
                ${ currentScenario.isChallenge ? '' : `
                <div class="mt-4 p-4 bg-gray-100 rounded-xl">
                    <h4 class="font-semibold mb-2">Vitals</h4>
                    <p><strong>Temp:</strong> ${patient.vitals.temp} | <strong>HR:</strong> ${patient.vitals.hr} | <strong>BP:</strong> ${patient.vitals.bp} | <strong>RR:</strong> ${patient.vitals.rr} | <strong>SpO2:</strong> ${patient.vitals.spO2}</p>
                </div>`}
            `;
        }
        
        function renderInitialActions() {
            actionsPanel.innerHTML = `
                <h3>Your Actions</h3>
                <div class="space-y-3 mt-4">
                    ${currentScenario.initialActions.map(action => `
                        <button class="btn btn-primary w-full" data-action="${action.action}">${action.text}</button>
                    `).join('')}
                </div>
            `;
        }

        function renderEmpiricChoices() {
            actionsPanel.innerHTML = `
                <h3>Choose Empiric Therapy</h3>
                <div class="space-y-3 mt-4">
                    ${currentScenario.empiricChoices.map(choice => `
                        <button class="btn-choice" data-action="selectEmpiric" data-choice-id="${choice.id}">${choice.text}</button>
                    `).join('')}
                </div>
            `;
        }

        function renderDefinitiveChoices(isChallenge = false) {
            const source = isChallenge ? currentChallengeCase.therapy : currentScenario;
            const choices = isChallenge ? source.choices : source.definitiveChoices;
            const questionText = isChallenge ? source.question : 'Based on your interpretation, choose the most appropriate definitive therapy.';
            
            actionsPanel.innerHTML = `
                <h3>${isChallenge ? 'Step 2: Choose Therapy' : 'Choose Definitive Therapy'}</h3>
                 <p class="text-sm text-gray-500 my-2">${questionText}</p>
                <div class="space-y-3 mt-4">
                     ${choices.map(choice => `
                        <button class="btn-choice" data-action="selectDefinitive" data-choice-id="${choice.id}">${choice.text}</button>
                    `).join('')}
                </div>
            `;
        }

        function addFeedback(message, type = 'info') {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `feedback-card feedback-${type}`;
            feedbackDiv.innerHTML = `<p>${message}</p>`;
            feedbackPanel.prepend(feedbackDiv);
        }
        
        function renderCultureReport(isFinal = false, caseData = null) {
            const organismSource = caseData ? caseData.organism : currentScenario.organism;
            const resistanceSource = caseData ? caseData.resistance : currentScenario.resistance;
            let reportHtml = '';

            if (isFinal) {
                const phenotypeHtml = Object.entries(resistanceSource.phenotype).map(([drug, result]) => {
                    const resultClass = result === 'S' ? 'report-s' : (result === 'R' ? 'report-r' : 'report-i');
                    return `<tr><td class="py-1 pr-4">${drug}</td><td class="font-mono ${resultClass}">${result}</td></tr>`;
                }).join('');
                reportHtml = `
                    <p class="font-semibold">Organism: <em class="font-medium">${organismSource.name}</em></p>
                    <p class="text-sm text-gray-500 mb-4">Source: ${organismSource.source}</p>
                    <table class="w-full text-left report-table">
                        <tbody>${phenotypeHtml}</tbody>
                    </table>`;
            } else {
                 reportHtml = '<p class="text-gray-500">Awaiting final culture results...</p>';
            }
            reportsContent.innerHTML = reportHtml;
        }

        function renderSummaryScreen() {
            summaryContent.innerHTML = `
                <p class="text-lg text-gray-600 mb-8">This guide summarizes the key resistance mechanisms and treatment principles covered in the simulation. Use it to reinforce your learning and as a quick reference for clinical decision-making.</p>

                <!-- ANTIMICROBIAL STEWARDSHIP -->
                <h3>Core Principles of Antimicrobial Stewardship</h3>
                <ul>
                    <li><strong>Source Control:</strong> Always address the root cause of infection. Drain abscesses, remove infected lines/hardware. Antibiotics alone may fail without it.</li>
                    <li><strong>Colonization vs. Infection:</strong> Treat the patient, not the culture result. Asymptomatic bacteriuria should not be treated with antibiotics.</li>
                    <li><strong>De-escalation:</strong> Once culture results are available, narrow the antibiotic spectrum to the most effective, targeted agent.</li>
                    <li><strong>Use Oral Agents When Possible:</strong> For stable patients with infections where oral agents have good bioavailability (e.g., uncomplicated cystitis), switch from IV to PO.</li>
                </ul>

                <!-- GRAM POSITIVE -->
                <h3>Gram-Positive Resistance</h3>
                <h4>Methicillin-Resistant Staphylococcus aureus (MRSA)</h4>
                <p>Identified by resistance to <code>Oxacillin</code> or <code>Cefoxitin</code>. This is mediated by the <code>mecA</code> gene.</p>
                <ul>
                    <li><strong>Preferred Agents:</strong> Vancomycin, Daptomycin, Linezolid.</li>
                    <li><strong>Vancomycin MIC Creep:</strong> For serious infections (bacteremia, endocarditis, osteomyelitis), if the Vancomycin MIC is 2 ¬µg/mL, consider alternative agents like Daptomycin or Linezolid due to risk of clinical failure.</li>
                    <li><strong>Prosthetic/Biofilm Infections:</strong> Always use combination therapy with <strong>Rifampin</strong> to penetrate the biofilm (e.g., <code>Vancomycin + Rifampin</code>). Never use Rifampin alone.</li>
                </ul>
                <h4>Vancomycin-Resistant Enterococcus (VRE)</h4>
                <p>Most common in <em>E. faecium</em>, which is also intrinsically resistant to ampicillin.</p>
                <ul>
                    <li><strong>Preferred Agents:</strong> Linezolid, Daptomycin.</li>
                    <li><strong>Synergy for Endocarditis:</strong> If treating endocarditis, synergy with an aminoglycoside is needed. You must check for <strong>High-Level Aminoglycoside Resistance (HLAR)</strong>. If HL-Gentamicin is 'R', you cannot use it for synergy.</li>
                </ul>

                <!-- GRAM NEGATIVE -->
                <h3>Gram-Negative Resistance</h3>
                <h4>Extended-Spectrum Œ≤-Lactamases (ESBLs)</h4>
                <p>Identified by resistance to 3rd-gen cephalosporins (e.g., <code>Ceftriaxone</code>) but susceptibility to carbapenems.</p>
                <ul>
                    <li><strong>Serious Infections (Bacteremia, Sepsis):</strong> Carbapenems (e.g., <code>Meropenem</code>, <code>Ertapenem</code>) are the drugs of choice.</li>
                    <li><strong>The Inoculum Effect:</strong> Be cautious using <code>Piperacillin-Tazobactam</code> for serious ESBL infections, even if it reports as 'S'. The high bacterial load can overwhelm the drug, leading to failure.</li>
                    <li><strong>Uncomplicated Cystitis (Stewardship):</strong> Use oral options like <code>Nitrofurantoin</code> or <code>Fosfomycin</code> to spare carbapenems.</li>
                </ul>

                <h4>Inducible AmpC Œ≤-Lactamases</h4>
                <p>Associated with <strong>SPICE-M</strong> organisms (<em>Serratia, Providencia, Indole-positive Proteae, Citrobacter, Enterobacter, Morganella</em>).</p>
                <ul>
                    <li><strong>The AmpC Trap:</strong> These organisms may test susceptible to 3rd-gen cephalosporins (e.g., <code>Ceftriaxone</code>), but can become resistant during therapy. <strong>Do not use them.</strong></li>
                    <li><strong>Preferred Agents:</strong> <code>Cefepime</code> (more stable) or a <code>Carbapenem</code>.</li>
                </ul>

                <h4>Carbapenem-Resistant Enterobacterales (CRE)</h4>
                <p>Identified by resistance to one or more carbapenems. The mechanism is critical for choosing therapy.</p>
                <ul>
                    <li><strong>KPC (Klebsiella pneumoniae carbapenemase):</strong> Susceptible to newer BL/BLIs like <code>Ceftazidime-Avibactam</code> and <code>Meropenem-Vaborbactam</code>.</li>
                    <li><strong>MBLs - Metallo-Œ≤-Lactamases (e.g., NDM, VIM):</strong> Resistant to almost all Œ≤-lactams/BL-inhibitors. Require novel agents like <code>Cefiderocol</code> or combination therapy such as <code>Ceftazidime-Avibactam + Aztreonam</code>.</li>
                    <li><strong>OXA-48-like:</strong> Often retain susceptibility to <code>Ceftazidime-Avibactam</code> but are resistant to Meropenem-Vaborbactam.</li>
                </ul>

                <h4>Difficult Non-fermenters</h4>
                <ul>
                    <li><strong>MDR Pseudomonas aeruginosa:</strong> Therapy is guided by susceptibilities. Agents like <code>Ceftolozane-Tazobactam</code> or <code>Ceftazidime-Avibactam</code> are often effective.</li>
                    <li><strong>Acinetobacter baumannii (CRAB):</strong> Often requires combination therapy. Options include high-dose ampicillin-sulbactam, polymyxins (colistin), or tetracyclines (minocycline, tigecycline).</li>
                    <li><strong>Stenotrophomonas maltophilia:</strong> Intrinsically resistant to carbapenems. Drug of choice is <code>TMP-SMX</code>.</li>
                </ul>
                
                <!-- FLOWCHART -->
                <h3>Treatment Decision Flowchart</h3>
                <div class="overflow-x-auto p-4 bg-gray-50 rounded-lg">
                    <div class="flowchart min-w-[800px]">
                        <!-- Gram-Positive Column -->
                        <div class="flowchart-col">
                            <div class="flow-box decision"><h4>Gram-Positive Cocci</h4></div>
                            <div class="flow-arrow down"></div>
                            <div class="flow-box decision"><h4>Staphylococcus or Enterococcus?</h4></div>
                            
                            <!-- Staph Branch -->
                            <div class="flow-arrow down"></div>
                            <div class="flow-box decision"><h4>Staph: Oxacillin Susceptible?</h4></div>
                            <div class="flex gap-4">
                                <div class="flowchart-col">
                                    <div class="flow-arrow down"></div>
                                    <div class="flow-box endpoint"><h4>MSSA</h4><p>Use Cefazolin, Nafcillin, or Dicloxacillin</p></div>
                                </div>
                                <div class="flowchart-col">
                                    <div class="flow-arrow down"></div>
                                    <div class="flow-box endpoint"><h4>MRSA</h4><p>Use Vancomycin, Linezolid, or Daptomycin</p></div>
                                    <div class="flow-arrow down"></div>
                                    <div class="flow-box warning"><h4>Biofilm / PJI?</h4><p>Add Rifampin</p></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gram-Negative Column -->
                        <div class="flowchart-col flex-shrink-0">
                            <div class="flow-box decision"><h4>Gram-Negative Rod</h4></div>
                            <div class="flow-arrow down"></div>
                            <div class="flow-box decision"><h4>Resistant to Ceftriaxone? (ESBL/AmpC Screen)</h4></div>
                             <div class="flex gap-4">
                                <!-- No Branch (Simple) -->
                                <div class="flowchart-col">
                                    <div class="flow-arrow down"></div>
                                    <div class="flow-box endpoint"><h4>NO</h4><p>Use Ceftriaxone (unless SPICE-M organism)</p></div>
                                </div>
                                <!-- Yes Branch (Complex) -->
                                <div class="flowchart-col">
                                    <div class="flow-arrow down"></div>
                                    <div class="flow-box decision"><h4>YES. Carbapenem Susceptible?</h4></div>
                                    <div class="flex gap-4">
                                        <div class="flowchart-col">
                                            <div class="flow-arrow down"></div>
                                            <div class="flow-box endpoint"><h4>YES (ESBL)</h4><p>Use Carbapenem for serious infection. Consider P/T or oral for UTI.</p></div>
                                        </div>
                                        <div class="flowchart-col">
                                            <div class="flow-arrow down"></div>
                                            <div class="flow-box warning"><h4>NO (CRE)</h4><p>Test for mechanism!</p></div>
                                            <div class="flow-arrow down"></div>
                                            <div class="flow-box endpoint"><h4>KPC: CZA, M-V<br>MBL: Cefiderocol, CZA+Azt<br>OXA-48: CZA</h4></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            switchView('summary-screen');
        }

        // --- LOGIC FUNCTIONS ---
        function resetSimulation() {
            switchView('scenario-selection-screen');
            currentScenario = null;
            currentChallengeCase = null;
            feedbackPanel.innerHTML = '';
        }

        function loadScenario(id) {
            currentScenario = scenarios.find(s => s.id === id);
            switchView('simulation-screen');

            scenarioTitle.textContent = currentScenario.title;
            renderPatientInfo();
            renderInitialActions();
            
            feedbackPanel.innerHTML = '';
            reportsContent.innerHTML = '<p class="text-gray-500">Awaiting specimen collection...</p>';
            
            if (currentScenario.stewardshipTip) {
                stewardshipTip.innerHTML = currentScenario.stewardshipTip;
                stewardshipPanel.classList.remove('hidden');
            } else {
                stewardshipPanel.classList.add('hidden');
            }
        }
        
        function handleAction(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const action = target.dataset.action;
            const choiceId = target.dataset.choiceId;

            switch(action) {
                case 'startEmpiricTherapy':
                    if (currentScenario.id === 7) { // AmpC trap
                         addFeedback("Patient started on Ceftriaxone for HAP. Cultures pending.", "info");
                        setTimeout(() => {
                            addFeedback("<strong>Day 4:</strong> Patient is worsening. Final culture report is now available.", "info");
                            renderCultureReport(true);
                            renderDefinitiveChoices();
                        }, 1500);
                    } else {
                        addFeedback("Cultures sent. Choose empiric therapy.", "info");
                        renderEmpiricChoices();
                    }
                    break;
                
                case 'selectEmpiric':
                    addFeedback("Final culture report is now available.", "info");
                    renderCultureReport(true);
                    renderDefinitiveChoices();
                    break;

                case 'showCultureOnly':
                    addFeedback("The culture report is available. Review and decide on a course of action.", "info");
                    renderCultureReport(true);
                    renderDefinitiveChoices();
                    break;

                case 'selectDefinitive':
                    handleDefinitiveChoice(choiceId, target.textContent);
                    break;
            }
        }
        
        function handleDefinitiveChoice(choiceId, choiceText) {
            const correctPath = currentScenario.correctPath ? currentScenario.correctPath.definitive : null;
            const isCorrect = Array.isArray(correctPath) ? correctPath.includes(choiceId) : choiceId === correctPath;

            let feedback = getScenarioFeedback(isCorrect, choiceId, choiceText);
            
            addFeedback(feedback, isCorrect ? 'correct' : 'incorrect');
            
            if (currentScenario.stewardshipTip) stewardshipPanel.classList.remove('hidden');

            actionsPanel.innerHTML = `
                <h3>Scenario Complete</h3>
                <div class="flex flex-col sm:flex-row gap-3 mt-4">
                    <button id="next-scenario-btn" class="btn btn-primary w-full">Back to Main Menu</button>
                    <button id="go-to-summary-btn" class="btn btn-secondary w-full">Review Learning Summary</button>
                </div>
            `;
            document.getElementById('next-scenario-btn').addEventListener('click', resetSimulation);
            document.getElementById('go-to-summary-btn').addEventListener('click', renderSummaryScreen);
        }
        
        function getScenarioFeedback(isCorrect, choiceId, choiceText) {
            if (isCorrect) return `<strong>Correct.</strong> Your choice of ${choiceText} is the optimal therapeutic path.`;
            
            switch(currentScenario.id) {
                case 1: return `<strong>Incorrect.</strong> For ESBL cystitis, a carbapenem is overkill, and other agents are resisted. Nitrofurantoin is the best stewardship choice.`;
                case 2: return `<strong>Incorrect.</strong> KPC enzymes require a targeted inhibitor like avibactam or vaborbactam. Colistin is a toxic, older option.`;
                case 3: return `<strong>Incorrect.</strong> NDM-1 is an MBL, which is not inhibited by avibactam. This requires specialized agents like Cefiderocol or Aztreonam-based combinations.`;
                case 4: return `<strong>Incorrect.</strong> The patient is asymptomatic. Treating colonization drives resistance and offers no benefit.`;
                case 5: return `<strong>Incorrect.</strong> For CRAB septic shock, aggressive combination therapy is needed. Colistin is a key component.`;
                case 6: return `<strong>Incorrect.</strong> Fluconazole resistance is common in non-albicans Candida like C. auris. An echinocandin is required.`;
                case 7: return `<strong>Incorrect.</strong> Continuing Ceftriaxone is falling into the 'AmpC trap'. Cefepime is the correct, more stable choice.`;
                case 9: return `<strong>Incorrect.</strong> The correct path involves both appropriate antimicrobial choice (Vancomycin or Daptomycin) AND removal of the infected catheter. Failure to achieve source control dooms therapy.`;
                case 10: return `<strong>Incorrect.</strong> While the organism is resistant to P/T, it remains susceptible to Cefepime. There is no need to escalate to a carbapenem.`;
                case 11: return `<strong>Incorrect.</strong> For prosthetic joint infections, Rifampin is crucial for its biofilm activity and must be used in combination to prevent resistance. Monotherapy is not appropriate.`;
                case 12: return `<strong>Incorrect.</strong> Once an ESBL is identified in a serious intra-abdominal infection, a carbapenem is the most reliable therapy. P/T carries a risk of failure due to the inoculum effect.`;
                case 13: return `<strong>Incorrect.</strong> Monotherapy for active TB is a critical error that breeds resistance. A multi-drug regimen (RIPE) is mandatory.`;
                default: return `<strong>Incorrect.</strong> This choice is not optimal based on the organism's resistance profile.`;
            }
        }

        // --- INITIALIZATION ---
        scenarioList.addEventListener('click', (e) => {
            const card = e.target.closest('.scenario-card');
            if (card) loadScenario(parseInt(card.dataset.id, 10));
        });
        backToMenuBtn.addEventListener('click', resetSimulation);
        backToMenuFromSummaryBtn.addEventListener('click', resetSimulation);
        actionsPanel.addEventListener('click', handleAction);
        showSummaryBtn.addEventListener('click', renderSummaryScreen);
        
        // Initial Load
        renderScenarioList();
        switchView('scenario-selection-screen');

    </script>
</body>
</html>

